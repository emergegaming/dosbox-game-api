{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["interface GameOptions {\n    cycles: number\n    zipFile: string\n    execCmd: string\n}\n\ninterface KeyMapping {\n    targetKey: string\n    replacementKeyCode: number\n}\n\n/**\n * DosGame. Object and helper methods to make it easier to run DOS games in a browser using DOSBox\n * @Author Mark van Wyk\n */\nexport class DosGame {\n\n    private dosRef: any;\n    private options: GameOptions\n    private canvas: HTMLCanvasElement\n    private ci: any\n    private keysToReplace:KeyMapping[] = []\n\n    /**\n     * Create a new DosGame object.\n     * Note that this object requires the JSDos script to be loaded by the page.\n     * <pre><code>\n     *   <script src=\"/dosbox/js-dos.js\"></script>\n     * </code></pre>\n     * @param dosRef a reference to window.DOS created by the included JavaScript file\n     * @param options {cycles:number, zipFile:string, execCmd:string}\n     * @param canvas reference to the HTMLCanvasElement DOSBox is being rendered on\n     */\n    constructor(dosRef:any, options:GameOptions, canvas:HTMLCanvasElement) {\n        this.dosRef = dosRef\n        this.options = options\n        this.canvas = canvas\n    }\n\n    start() {\n        return new Promise((resolve, reject):any => {\n            this.dosRef(this.canvas, {\n                cycles: this.options.cycles,\n                wdosboxUrl: '/dosbox/wdosbox.js',\n                onprogress: () => {},\n                log: () => {}\n            }).ready((fs, main) => {\n                fs.extract(this.options.zipFile).then(() => {\n                    main([\"-c\", this.options.execCmd]).then((ci) => {\n                        this.ci = ci\n                        resolve(ci)\n                        window.addEventListener('unload', this.unload)\n                    })\n                })\n            })\n        })\n    }\n\n    /**\n     * Capture a key (hopefully before the emulator gets it and replace it with a different key\n     * @param targetKey the event.key (not the ascii code) we're looking for.\n     * @param replacementKeyCode the ASCII key to send to DOSBox\n     * @see https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent/key\n     */\n    overrideKey(targetKey:string, replacementKeyCode:number): void {\n        if (this.keysToReplace.length === 0) this.addKeyEventListeners()\n        this.keysToReplace.push({targetKey:targetKey, replacementKeyCode:replacementKeyCode})\n    }\n\n    /** Private Methods **/\n\n    /**\n     * Create key event listeners\n     * @private\n     */\n    private addKeyEventListeners() {\n        window.addEventListener('keyup', this.handleKeyEvent.bind(this))\n        window.addEventListener('keydown', this.handleKeyEvent.bind(this))\n    }\n\n    /**\n     * When a key is pressed (keydown) or released (keyup), check to see if it's a mapped key and rather send the\n     * preferred key to DosBox.\n     * @param event KeyboardEvent of the pressed or released key\n     * @private\n     */\n    private handleKeyEvent(event:KeyboardEvent) {\n        if (event.key) {\n            for (let i: number = 0; i < this.keysToReplace.length; i++) {\n                let keyMapping:KeyMapping = this.keysToReplace[i]\n                if (event.key == keyMapping.targetKey) {\n                    event.preventDefault()\n                    event.stopImmediatePropagation()\n                    this.ci.simulateKeyEvent(keyMapping.replacementKeyCode, event.type == 'keydown')\n                }\n            }\n        }\n    }\n\n    /**\n     * When a user clicks away, unload the WASM code\n     * @private\n     */\n    private unload() {\n        this.ci.exit()\n    }\n}\n"],"names":["dosRef","options","canvas","this","DosGame","Promise","resolve","reject","_this","cycles","wdosboxUrl","onprogress","log","ready","fs","main","extract","zipFile","then","execCmd","ci","window","addEventListener","unload","targetKey","replacementKeyCode","keysToReplace","length","addKeyEventListeners","push","handleKeyEvent","bind","event","key","i","keyMapping","preventDefault","stopImmediatePropagation","simulateKeyEvent","type","exit"],"mappings":"iBAiCI,WAAYA,EAAYC,EAAqBC,GAZrCC,mBAA6B,GAajCA,KAAKH,OAASA,EACdG,KAAKF,QAAUA,EACfE,KAAKD,OAASA,EAsEtB,OAnEIE,kBAAA,WAAA,WACI,OAAO,IAAIC,SAAQ,SAACC,EAASC,GACzBC,EAAKR,OAAOQ,EAAKN,OAAQ,CACrBO,OAAQD,EAAKP,QAAQQ,OACrBC,WAAY,qBACZC,WAAY,aACZC,IAAK,eACNC,OAAM,SAACC,EAAIC,GACVD,EAAGE,QAAQR,EAAKP,QAAQgB,SAASC,MAAK,WAClCH,EAAK,CAAC,KAAMP,EAAKP,QAAQkB,UAAUD,MAAK,SAACE,GACrCZ,EAAKY,GAAKA,EACVd,EAAQc,GACRC,OAAOC,iBAAiB,SAAUd,EAAKe,qBAa3DnB,wBAAA,SAAYoB,EAAkBC,GACQ,IAA9BtB,KAAKuB,cAAcC,QAAcxB,KAAKyB,uBAC1CzB,KAAKuB,cAAcG,KAAK,CAACL,UAAUA,EAAWC,mBAAmBA,KAS7DrB,iCAAR,WACIiB,OAAOC,iBAAiB,QAASnB,KAAK2B,eAAeC,KAAK5B,OAC1DkB,OAAOC,iBAAiB,UAAWnB,KAAK2B,eAAeC,KAAK5B,QASxDC,2BAAR,SAAuB4B,GACnB,GAAIA,EAAMC,IACN,IAAK,IAAIC,EAAY,EAAGA,EAAI/B,KAAKuB,cAAcC,OAAQO,IAAK,CACxD,IAAIC,EAAwBhC,KAAKuB,cAAcQ,GAC3CF,EAAMC,KAAOE,EAAWX,YACxBQ,EAAMI,iBACNJ,EAAMK,2BACNlC,KAAKiB,GAAGkB,iBAAiBH,EAAWV,mBAAkC,WAAdO,EAAMO,SAUtEnC,mBAAR,WACID,KAAKiB,GAAGoB"}