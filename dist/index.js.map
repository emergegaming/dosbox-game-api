{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["interface GameOptions {\n    cycles: number\n    zipFile: string\n    execCmd: string\n}\n\ninterface KeyMapping {\n    targetKey: string\n    replacementKeyCode: number\n}\n\ninterface Directions {\n    directions: number\n}\n\ninterface ButtonMapping {\n    element:HTMLElement\n    asciiCode:number\n}\n\ninterface PressedButton {\n    id: number,\n    elem: HTMLElement,\n    x: number\n    y: number\n}\n\ninterface Origin {\n    x: number\n    y: number\n    id: number\n}\n\n/**\n * DosGame. Object and helper methods to make it easier to run DOS games in a browser using DOSBox\n * @Author Mark van Wyk\n * @copyright Emerge Gaming @copy; 2021\n */\nexport class DosGame {\n\n    private dosRef: any;\n    private options: GameOptions\n    private canvas: HTMLCanvasElement\n    private ci: any\n    private keysToReplace:KeyMapping[] = []\n    private directions:Directions\n    private buttons:ButtonMapping[] = []\n    private pressedButtons:PressedButton[] = []\n    private origin:Origin = {x:null, y:null, id:null}\n    private lastDirection:any[] = []\n\n    /**\n     * Create a new DosGame object.\n     * that this object requires the JSDos script to be loaded by the page.\n     *\n     * eg: <script src=\"/dosbox/js-dos.js\"></script>\n     *\n     * @param dosRef a reference to window.DOS created by the included JavaScript file\n     * @param options {cycles:number, zipFile:string, execCmd:string}\n     * @param canvas reference to the HTMLCanvasElement DOSBox is being rendered on\n     *\n     * @see https://js-dos.com/\n     */\n    constructor(dosRef:any, options:GameOptions, canvas:HTMLCanvasElement) {\n        this.dosRef = dosRef\n        this.options = options\n        this.canvas = canvas\n    }\n\n    public start():Promise<any> {\n        return new Promise((resolve) => {\n            this.dosRef(this.canvas, {\n                cycles: this.options.cycles,\n                wdosboxUrl: '/dosbox/wdosbox.js',\n                onprogress: () => {},\n                log: () => {}\n            }).ready((fs, main) => {\n                fs.extract(this.options.zipFile).then(() => {\n                    main([\"-c\", this.options.execCmd]).then((ci) => {\n                        this.ci = ci\n                        resolve(ci)\n                        window.addEventListener('unload', this.unload)\n                    })\n                })\n            })\n        })\n    }\n\n    /**\n     * Capture a key (hopefully before the emulator gets it and replace it with a different key\n     * @param targetKey the event.key (not the ascii code) we're looking for.\n     * @param replacementKeyCode the ASCII key to send to DOSBox\n     * @see https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent/key\n     */\n    public overrideKey(targetKey:string, replacementKeyCode:number):void {\n        if (this.keysToReplace.length === 0) this.addKeyEventListeners()\n        this.keysToReplace.push({targetKey:targetKey, replacementKeyCode:replacementKeyCode})\n    }\n\n    /**\n     * Convert touch dragging to\n     * @param directions\n     */\n    public mapTouchToArrowKeys(directions:Directions):void {\n        this.directions = directions\n        if (this.buttons.length == 0) {\n            this.addTouchEventListeners()\n        }\n    }\n\n    /**\n     *\n     * @param buttonMapping\n     */\n    public mapButtonToKey(buttonMapping:ButtonMapping):void {\n        this.buttons.push(buttonMapping)\n        if (!this.directions) {\n            this.addTouchEventListeners()\n        }\n\n    }\n\n    /***** P R I V A T E   M E T H O D S *****/\n\n    /**\n     * Create key event listeners\n     * @private\n     */\n    private addKeyEventListeners() {\n        window.addEventListener('keyup', this.handleKeyEvent.bind(this))\n        window.addEventListener('keydown', this.handleKeyEvent.bind(this))\n    }\n\n    /**\n     * Create touch listeners\n     */\n    addTouchEventListeners() {\n        document.addEventListener('touchstart', this.handleTouchEvent.bind(this))\n        document.addEventListener('touchend', this.handleTouchEvent.bind(this))\n        document.addEventListener('touchmove', this.handleTouchEvent.bind(this))\n    }\n\n    /**\n     * When a key is pressed (keydown) or released (keyup), check to see if it's a mapped key and rather send the\n     * preferred key to DosBox.\n     * @param event KeyboardEvent of the pressed or released key\n     * @private\n     */\n    private handleKeyEvent(event:KeyboardEvent) {\n        if (event.key) {\n            for (let i: number = 0; i < this.keysToReplace.length; i++) {\n                let keyMapping:KeyMapping = this.keysToReplace[i]\n                if (event.key == keyMapping.targetKey) {\n                    event.preventDefault()\n                    event.stopImmediatePropagation()\n                    this.ci.simulateKeyEvent(keyMapping.replacementKeyCode, event.type == 'keydown')\n                }\n            }\n        }\n    }\n\n    /**\n     * Handle the touch events\n     * @private\n     * @param event\n     */\n    private handleTouchEvent(event:TouchEvent) {\n        if (event.type == 'touchstart') {\n            for (let i:number = 0; i < event.changedTouches.length; i++) {\n                let startingTouch = event.changedTouches[i]\n                if (startingTouch.clientX < 200) {\n                    this.setOrigin(startingTouch)\n                }  else {\n                    for (let j:number = 0; j < this.buttons.length; j++) {\n                        let mapping:ButtonMapping = this.buttons[j]\n                        let rect = mapping.element.getBoundingClientRect()\n                        let x1 = rect.x, x2 = rect.x + rect.width, y1 = rect.y, y2 = rect.y + rect.height;\n                        if (startingTouch.clientX > x1 && startingTouch.clientX < x2 && startingTouch.clientY > y1 && startingTouch.clientY < y2) {\n                            this.pressedButtons.push({id:startingTouch.identifier, x:startingTouch.clientX, y:startingTouch.clientY, elem: mapping.element});\n                            this.ci.simulateKeyPress(mapping.asciiCode, true)\n                        }\n                    }\n                }\n            }\n\n        } else if (event.type == 'touchmove') {\n            for (let i:number = 0; i < event.changedTouches.length; i++) {\n                let movingTouch:Touch = event.changedTouches[i]\n                if (movingTouch.clientX < 200) {\n                    let control = []\n                    let dx = movingTouch.clientX - this.origin.x;\n                    let dy = movingTouch.clientY - this.origin.y;\n                    if (dx === 0 && dy === 0) return\n                    let r = Math.sqrt(Math.pow(dx, 2) + Math.pow(dy, 2))\n                    let angle = this.radToDeg(Math.asin(dy/r)) + 90\n                    if (dx < 0) angle = (180 - angle) + 180\n\n                    if (this.directions.directions === 4) {\n                        if (angle >= 315 || angle < 45) control=['up']\n                        else if (angle >= 45 && angle < 135) control=['right']\n                        else if (angle >= 135 && angle < 225) control = ['down']\n                        else if (angle >= 225 && angle < 315) control = ['left']\n                        else {\n                            console.error ('unknown angle ' + angle);\n                        }\n                    } else if (this.directions.directions === 8) {\n                        if (angle >= 338 || angle < 23) control = ['up']\n                        else if (angle >= 23 && angle < 68) control = ['up', 'right']\n                        else if (angle >= 68 && angle < 113) control = ['right']\n                        else if (angle >= 113 && angle < 158) control = ['down', 'right']\n                        else if (angle >= 158 && angle < 203) control = ['down']\n                        else if (angle >= 203 && angle < 248) control = ['down', 'left']\n                        else if (angle >= 248 && angle < 293) control = ['left']\n                        else if (angle >= 293 && angle < 338) control = ['up', 'left']\n                        else {\n                            console.error ('unknown angle '+ angle);\n                        }\n                    } else {\n                        console.error('directions need to be 4 or 8')\n                    }\n\n                    this.processDirectionChange(this.lastDirection, control)\n                    this.lastDirection = control;\n                }\n\n            }\n        } else if (event.type == 'touchend') {\n            for (let i = 0; i < event.changedTouches.length; i++) {\n                let endingTouch:Touch = event.changedTouches[i];\n                if (endingTouch.identifier === this.origin.id) {\n                    this.origin.x = null;\n                    this.origin.y = null;\n                    this.origin.id = null;\n                    if (this.lastDirection.length > 0) {\n                        this.processDirectionChange(this.lastDirection, [])\n                    }\n                    this.lastDirection = [];\n                }\n                // } else {\n                //     let released = this.pressedButtons.find(item => item.id === endingTouch.identifier)\n                //     if (released) {\n                //         this.ci.simulateKeyPress(released.id, false)\n                //         this.pressedButtons = this.pressedButtons.filter(item => item.id !== endingTouch.identifier)\n                //     }\n                // }\n            }\n        }\n    }\n\n    private processDirectionChange = (was, is) => {\n        console.log (\"was \", was)\n        console.log (\"is \", is)\n        console.log (\"---\")\n\n        let turnOff = was.filter(w => is.indexOf(w) === -1)\n        let turnOn = is.filter(i => was.indexOf(i) === -1)\n        turnOff.forEach((direction) => {\n            console.log(\"ending \" + direction)\n            this.ci.simulateKeyEvent(this.getDirectionAscii(direction), false);\n        });\n        turnOn.forEach((direction) => {\n            console.log (\"starting \" + direction)\n            this.ci.simulateKeyEvent(this.getDirectionAscii(direction), true)\n        });\n    }\n\n    /**\n     * Returns the ascii code for the corresponding arrow key\n     * @param direction\n     * @private\n     */\n    private getDirectionAscii(direction:string):number {\n        switch (direction) {\n            case 'up'  : return 38;\n            case 'down': return 40;\n            case 'left': return 37;\n            case 'right': return 39;\n        }\n    }\n\n    /**\n     * Convert radians tp degrees\n     * @param rad the angle in radians\n     */\n    private radToDeg = (rad) => {\n        return Math.round(rad * 180 / Math.PI);\n    }\n\n    /**\n     * Set the starting point (touch)\n     * @param touchEvent the touch event where the movement started\n     * @private\n     */\n    private setOrigin(touchEvent:Touch) {\n        this.origin = {x:touchEvent.clientX, y:touchEvent.clientY, id:touchEvent.identifier}\n    }\n\n    /**\n     * When a user clicks away, unload the WASM code\n     * @private\n     */\n    private unload() {\n        this.ci.exit()\n    }\n}\n"],"names":["dosRef","options","canvas","this","x","y","id","was","is","console","log","turnOff","filter","w","indexOf","turnOn","i","forEach","direction","_this","ci","simulateKeyEvent","getDirectionAscii","rad","Math","round","PI","DosGame","Promise","resolve","cycles","wdosboxUrl","onprogress","ready","fs","main","extract","zipFile","then","execCmd","window","addEventListener","unload","targetKey","replacementKeyCode","keysToReplace","length","addKeyEventListeners","push","directions","buttons","addTouchEventListeners","buttonMapping","handleKeyEvent","bind","document","handleTouchEvent","event","key","keyMapping","preventDefault","stopImmediatePropagation","type","changedTouches","startingTouch","clientX","setOrigin","j","mapping","rect","element","getBoundingClientRect","x1","x2","width","y1","y2","height","clientY","pressedButtons","identifier","elem","simulateKeyPress","asciiCode","movingTouch","control","dx","origin","dy","r","sqrt","pow","angle","radToDeg","asin","error","processDirectionChange","lastDirection","touchEvent","exit"],"mappings":"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"}