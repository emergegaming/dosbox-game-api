var t=function(){function t(t,e,i,n){var o=this;void 0===n&&(n=!1),this.keysToReplace=[],this.buttons=[],this.origin={x:null,y:null,id:null},this.lastDirection=[],this.pixelListeners=[],this.keysDown=[],this.dPadMode=!1,this.touchEventListenersAdded=!1,this.directionMapping={up:38,down:40,left:37,right:39},this.overrideDirectionAscii=function(t){o.directionMapping=t},this.processDirectionChange=function(t,e){var i=t.filter((function(t){return-1===e.indexOf(t)})),n=e.filter((function(e){return-1===t.indexOf(e)}));i.forEach((function(t){o.ci.simulateKeyEvent(o.getDirectionAscii(t),!1)})),n.forEach((function(t){o.ci.simulateKeyEvent(o.getDirectionAscii(t),!0)}))},this.radToDeg=function(t){return Math.round(180*t/Math.PI)},this.dosRef=t,this.options=e,this.canvas=i,this.forceKeyPress=n}return t.prototype.start=function(){var t=this;return new Promise((function(e){t.dosRef(t.canvas,{cycles:t.options.cycles,wdosboxUrl:"/dosbox/wdosbox.js",onprogress:function(){},log:function(){}}).ready((function(i,n){i.extract(t.options.zipFile).then((function(){n(t.options.execCmdArray).then((function(i){t.ci=i,e(i),window.focus(),window.addEventListener("unload",t.unload)}))}))}))}))},t.prototype.getCommandInterface=function(){return this.ci},t.prototype.startWithConf=function(t){var e=this;return new Promise((function(i){e.options.execCmdArray.push("-conf"),e.options.execCmdArray.push("dosbox.conf"),e.dosRef(e.canvas,{wdosboxUrl:"/dosbox/wdosbox.js"}).ready((function(n,o){n.extract(e.options.zipFile).then((function(){n.createFile("dosbox.conf",t),o(e.options.execCmdArray).then((function(t){e.ci=t,i(t),window.focus(),window.addEventListener("unload",e.unload)}))}))}))}))},t.prototype.overrideKey=function(t,e){0===this.keysToReplace.length&&this.addKeyEventListeners(),this.keysToReplace.push({targetKey:t,replacementKeyCode:e})},t.prototype.mapTouchToArrowKeys=function(t){this.directions=t,0==this.buttons.length&&this.addTouchEventListeners()},t.prototype.mapDPadToArrowKeys=function(t){this.dPadBounds=t.getBoundingClientRect(),console.log("Init dPad"),console.log(this.dPadBounds),this.dPadMode=!0,this.addTouchEventListeners()},t.prototype.mapButtonToKey=function(t){this.buttons.push(t),this.directions||this.addTouchEventListeners()},t.prototype.autoKeyPress=function(t,e){var i=this;return void 0===e&&(e=0),new Promise((function(n,o){return setTimeout((function(){i.ci.simulateKeyPress(t),e>0&&n&&n(null)}),e)}))},t.prototype.setPixelListener=function(t,e,i,n){void 0===n&&(n=1e3),this.addPixelListener(t,e,i,n)},t.prototype.addPixelListener=function(t,e,i,n){void 0===n&&(n=1e3),this.interval||(this.interval=window.setInterval(this.doIntervalPoll.bind(this),n)),this.pixelListeners.push({x:t,y:e,callback:i,lastColor:void 0}),this.canvasContext||(this.canvasContext=this.canvas.getContext("2d"))},t.prototype.setGeneralPixelCallback=function(t){this.generalPixelCallback=t},t.prototype.stopPixelListener=function(){window.clearInterval(this.interval)},t.prototype.consoleScreenshots=function(){var t=this;setInterval((function(){console.log(t.canvas.toDataURL("img/png"))}),1500)},t.prototype.doIntervalPoll=function(){var e=this,i=[];this.pixelListeners.forEach((function(n){var o=e.canvasContext.getImageData(n.x,n.y,1,1),s="#"+t.getHexValue(o.data[0])+t.getHexValue(o.data[1])+t.getHexValue(o.data[2]);i.push(s),s!=n.lastColor&&(n.callback(s),n.lastColor=s)})),this.generalPixelCallback&&this.generalPixelCallback(i)},t.getHexValue=function(t){return("00"+t.toString(16)).slice(-2)},t.prototype.addKeyEventListeners=function(){window.addEventListener("keyup",this.handleKeyEvent.bind(this)),window.addEventListener("keydown",this.handleKeyEvent.bind(this))},t.prototype.addTouchEventListeners=function(){this.touchEventListenersAdded||(document.addEventListener("touchstart",this.handleTouchEvent.bind(this)),document.addEventListener("touchend",this.handleTouchEvent.bind(this)),document.addEventListener("touchmove",this.handleTouchEvent.bind(this)),this.touchEventListenersAdded=!0)},t.prototype.handleKeyEvent=function(t){if(("keydown"===t.type||"keyup"===t.type)&&0==t.metaKey){var e=this.findReplacementKeyCode(t.key);e&&("keydown"!==t.type||this.keysDown.includes(t.key)||(this.forceKeyPress?this.ci.simulateKeyPress(e,!0):this.ci.simulateKeyEvent(e,!0),this.keysDown.push(t.key)),"keyup"===t.type&&this.keysDown.includes(t.key)&&(this.forceKeyPress?this.ci.simulateKeyPress(e,!1):this.ci.simulateKeyEvent(e,!1),this.keysDown.splice(this.keysDown.indexOf(t.key),1)),t.stopImmediatePropagation(),t.stopPropagation(),t.preventDefault())}},t.prototype.findReplacementKeyCode=function(t){var e;return(null===(e=this.keysToReplace.find((function(e){return e.targetKey==t})))||void 0===e?void 0:e.replacementKeyCode)||null},t.prototype.handleTouchEvent=function(t){if(console.log("touchevent"),console.log(t),"touchstart"==t.type)for(var e=0;e<t.changedTouches.length;e++){var i=t.changedTouches[e];if(!this.dPadMode&&i.clientX<200)this.setOrigin(i);else for(var n=0;n<this.buttons.length;n++){if(this.dPadMode){var o=(i.clientX-this.dPadBounds.left)/this.dPadBounds.width*100,s=(i.clientY-this.dPadBounds.top)/this.dPadBounds.height*100;if(o>=0&&o<=100&&s>0&&s<=100){s<33?o>33&&o<67&&this.ci.simulateKeyPress(this.directionMapping.up):s<67?o<33?this.ci.simulateKeyPress(this.directionMapping.left):o>67&&this.ci.simulateKeyPress(this.directionMapping.right):o>33&&o<67&&this.ci.simulateKeyPress(this.directionMapping.down);continue}}var r=this.buttons[n],a=r.element.getBoundingClientRect(),c=a.x,d=a.x+a.width,h=a.y,l=a.y+a.height;i.clientX>c&&i.clientX<d&&i.clientY>h&&i.clientY<l&&this.ci.simulateKeyPress(r.asciiCode,!0)}}else if(0==this.dPadMode&&"touchmove"==t.type)for(e=0;e<t.changedTouches.length;e++){var u=t.changedTouches[e];if(u.clientX<200){var p=[],y=u.clientX-this.origin.x,f=u.clientY-this.origin.y;if(0===y&&0===f||isNaN(y)||isNaN(f))return;var g=.38*f,v=2.61*f;8===this.directions.directions?y<-Math.abs(v)?p=["left"]:f<0&&y<g?p=["up","left"]:f<0&&y<Math.abs(g)?p=["up"]:f<0&&y<-v?p=["up","right"]:y>Math.abs(v)?p=["right"]:f>0&&y<-Math.abs(g)?p=["down","right"]:f>0&&y<g?p=["down"]:f>0&&y<f*v?p=["down","left"]:console.log("Not a known angle / direction"):4===this.directions.directions?y<0&&y<-Math.abs(f)?p=["left"]:f<0&&y<-f?p=["up"]:y>0&&y>Math.abs(f)?p=["right"]:f>0&&y<f?p=["down"]:console.log("Not a known angle / direction"):2===this.directions.directions?y<0?p=["left"]:y>0?p=["right"]:console.log("Not a known angle / direction"):console.error("Only 2, 4 or 8 directions allowed"),this.processDirectionChange(this.lastDirection,p),this.lastDirection=p}}else if("touchend"==t.type)for(e=0;e<t.changedTouches.length;e++){t.changedTouches[e].identifier===this.origin.id&&(this.origin.x=null,this.origin.y=null,this.origin.id=null,this.lastDirection.length>0&&this.processDirectionChange(this.lastDirection,[]),this.lastDirection=[])}},t.prototype.getDirectionAscii=function(t){return this.directionMapping[t]},t.prototype.setOrigin=function(t){this.origin={x:t.clientX,y:t.clientY,id:t.identifier}},t.prototype.unload=function(){this.dosRef.exit()},t.isTouch=function(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0},t}();export{t as DosGame};
//# sourceMappingURL=index.js.map
