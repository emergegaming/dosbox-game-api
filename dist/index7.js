/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function e(e,t,n,i){return new(n||(n=Promise))((function(o,s){function r(e){try{c(i.next(e))}catch(e){s(e)}}function a(e){try{c(i.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((i=i.apply(e,t||[])).next())}))}function t(e,t){var n,i,o,s,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,i&&(o=2&s[0]?i.return:s[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,s[1])).done)return o;switch(i=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return r.label++,{value:s[1],done:!1};case 5:r.label++,i=s[1],s=[0];continue;case 7:s=r.ops.pop(),r.trys.pop();continue;default:if(!(o=r.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){r=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){r.label=s[1];break}if(6===s[0]&&r.label<o[1]){r.label=o[1],o=s;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(s);break}o[2]&&r.ops.pop(),r.trys.pop();continue}s=t.call(e,r)}catch(e){s=[6,e],i=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}}var n=function(){function n(e,t,n,i){var o=this;void 0===i&&(i=!1),this.keysToReplace=[],this.buttons=[],this.origin={x:null,y:null,id:null},this.lastDirection=[],this.pixelListeners=[],this.keysDown=[],this.dPadMode=!1,this.touchEventListenersAdded=!1,this.reverseKeyMap=new Map,this.directionMapping={up:38,down:40,left:37,right:39},this.overrideDirectionAscii=function(e){o.directionMapping=e},this.processDirectionChange=function(e,t){var n=e.filter((function(e){return-1===t.indexOf(e)})),i=t.filter((function(t){return-1===e.indexOf(t)}));n.forEach((function(e){o.ci.sendKeyEvent(o.jsdosKeyCodeLookup(o.getDirectionAscii(e)),!1)})),i.forEach((function(e){o.ci.sendKeyEvent(o.jsdosKeyCodeLookup(o.getDirectionAscii(e)),!0)}))},this.radToDeg=function(e){return Math.round(180*e/Math.PI)},this.dosRef=e,this.rootElement=t,this.forceKeyPress=i,this.emulators=n}return n.prototype.jsdosKeyCodeLookup=function(e){var t=this.reverseKeyMap.get(e);if(null!=t)return t;console.warn("%c That Key is not Mapped, check index7.ts -> start7()","background: #000000; color: #00ff00")},n.prototype.start=function(){var e=this;return new Promise((function(t){e.dosRef(e.canvas,{cycles:e.options.cycles,wdosboxUrl:"/dosbox/wdosbox.js",onprogress:function(){},log:function(){}}).ready((function(n,i){n.extract(e.options.zipFile).then((function(){i(e.options.execCmdArray).then((function(n){e.ci=n,t(n),window.focus(),window.addEventListener("unload",e.unload)}))}))}))}))},n.prototype.start7=function(n){var i=this;return new Promise((function(o){return e(i,void 0,void 0,(function(){var e=this;return t(this,(function(t){return this.reverseKeyMap.set(32,32),this.reverseKeyMap.set(38,265),this.reverseKeyMap.set(40,264),this.reverseKeyMap.set(37,263),this.reverseKeyMap.set(39,262),this.reverseKeyMap.set(18,342),this.reverseKeyMap.set(16,340),this.reverseKeyMap.set(66,66),this.reverseKeyMap.set(88,88),this.reverseKeyMap.set(188,44),this.reverseKeyMap.set(190,46),this.reverseKeyMap.set(191,47),this.reverseKeyMap.set(72,72),this.emulators.pathPrefix="/dosbox/dos7/",this.dosRef(this.rootElement).run(n).then((function(t){e.ci=t,e.canvas=e.rootElement.getElementsByTagName("canvas")[0],e.canvasContext=e.canvas.getContext("webgl"),console.log(e.canvasContext),o(t)})),[2]}))}))}))},n.prototype.getCommandInterface=function(){return this.ci},n.prototype.startWithConf=function(e){var t=this;return new Promise((function(n){t.options.execCmdArray.push("-conf"),t.options.execCmdArray.push("dosbox.conf"),t.dosRef(t.canvas,{wdosboxUrl:"/dosbox/wdosbox.js"}).ready((function(i,o){i.extract(t.options.zipFile).then((function(){i.createFile("dosbox.conf",e),o(t.options.execCmdArray).then((function(e){t.ci=e,n(e),window.focus(),window.addEventListener("unload",t.unload)}))}))}))}))},n.prototype.overrideKey=function(e,t){0===this.keysToReplace.length&&this.addKeyEventListeners(),this.keysToReplace.push({targetKey:e,replacementKeyCode:t})},n.prototype.mapTouchToArrowKeys=function(e){this.directions=e,0==this.buttons.length&&this.addTouchEventListeners()},n.prototype.mapDPadToArrowKeys=function(e){this.dPadBounds=e.getBoundingClientRect(),this.dPadMode=!0,this.addTouchEventListeners()},n.prototype.mapButtonToKey=function(e){this.buttons.push({element:e.element,asciiCode:this.jsdosKeyCodeLookup(e.asciiCode)}),this.directions||this.addTouchEventListeners()},n.prototype.autoKeyPress=function(e,t){var n=this;return void 0===t&&(t=0),new Promise((function(i,o){return setTimeout((function(){n.ci.simulateKeyPress(e),t>0&&i&&i(null)}),t)}))},n.prototype.setPixelListener=function(e,t,n,i){this.addPixelListener(e,t,n,i)},n.prototype.addPixelListener=function(e,t,n,i){if(this.pixelListeners.push({x:e,y:t,callback:n,lastColor:void 0}),!this.interval){var o=this;window.setInterval((function(){o.interval=o.doIntervalPoll.bind(o)(i)}),1e3)}console.log("PL Lenght; "+this.pixelListeners.length)},n.prototype.setGeneralPixelCallback=function(e){this.generalPixelCallback=e},n.prototype.stopPixelListener=function(){window.clearInterval(this.interval)},n.prototype.greet=function(){return"Hello World"},n.prototype.consoleSingleScreenShot=function(e,t){var n=this,i=document.createElement("canvas");i.width=320,i.height=200;var o=i.getContext("2d");return this.ci.screenshot().then((function(s){o.putImageData(s,0,0),e&&console.log(i.toDataURL("img/png")),n.retVal=t?i.toDataURL("img/png"):s})),this.retVal},n.prototype.consoleScreenshots=function(e){var t=this;setInterval((function(){t.consoleSingleScreenShot(e,!0)}),1500)},n.prototype.doIntervalPoll=function(e){var t=this,i=[],o=document.createElement("canvas");o.width=320,o.height=200;var s=o.getContext("2d");this.ci.screenshot().then((function(o){s.putImageData(o,0,0),t.pixelListeners.forEach((function(t){var o=s.getImageData(t.x,t.y,1,1),r="#"+n.getHexValue(o.data[0])+n.getHexValue(o.data[1])+n.getHexValue(o.data[2]);e&&console.log("HEXVALUE: "+r),i.push(r),r!=t.lastColor&&(t.callback(r),t.lastColor=r)}))}))},n.getHexValue=function(e){return("00"+e.toString(16)).slice(-2)},n.prototype.addKeyEventListeners=function(){window.addEventListener("keyup",this.handleKeyEvent.bind(this)),window.addEventListener("keydown",this.handleKeyEvent.bind(this))},n.prototype.addTouchEventListeners=function(){this.touchEventListenersAdded||(document.addEventListener("touchstart",this.handleTouchEvent.bind(this)),document.addEventListener("touchend",this.handleTouchEvent.bind(this)),document.addEventListener("touchmove",this.handleTouchEvent.bind(this)),this.touchEventListenersAdded=!0)},n.prototype.handleKeyEvent=function(e){if(("keydown"===e.type||"keyup"===e.type)&&0==e.metaKey){var t=this.findReplacementKeyCode(e.key);t&&("keydown"!==e.type||this.keysDown.includes(e.key)||(this.forceKeyPress?this.ci.simulateKeyPress(t,!0):this.ci.simulateKeyEvent(t,!0),this.keysDown.push(e.key)),"keyup"===e.type&&this.keysDown.includes(e.key)&&(this.forceKeyPress?this.ci.simulateKeyPress(t,!1):this.ci.simulateKeyEvent(t,!1),this.keysDown.splice(this.keysDown.indexOf(e.key),1)),e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault())}},n.prototype.findReplacementKeyCode=function(e){var t;return(null===(t=this.keysToReplace.find((function(t){return t.targetKey==e})))||void 0===t?void 0:t.replacementKeyCode)||null},n.prototype.handleTouchEvent=function(e){if("touchstart"==e.type)for(var t=0;t<e.changedTouches.length;t++){var n=e.changedTouches[t];if(!this.dPadMode&&n.clientX<200)this.setOrigin(n);else for(var i=0;i<this.buttons.length;i++){if(this.dPadMode){var o=(n.clientX-this.dPadBounds.left)/this.dPadBounds.width*100,s=(n.clientY-this.dPadBounds.top)/this.dPadBounds.height*100;if(o>=0&&o<=100&&s>0&&s<=100){s<33?o>33&&o<67&&this.ci.simulateKeyPress(this.directionMapping.up,!0):s<67?o<33?this.ci.simulateKeyPress(this.directionMapping.left,!0):o>67&&this.ci.simulateKeyPress(this.directionMapping.right,!0):o>33&&o<67&&this.ci.simulateKeyPress(this.directionMapping.down,!0);continue}}var r=this.buttons[i],a=r.element.getBoundingClientRect(),c=a.x,h=a.x+a.width,d=a.y,u=a.y+a.height;n.clientX>c&&n.clientX<h&&n.clientY>d&&n.clientY<u&&this.ci.simulateKeyPress(r.asciiCode,!0)}}else if(0==this.dPadMode&&"touchmove"==e.type)for(t=0;t<e.changedTouches.length;t++){var l=e.changedTouches[t];if(l.clientX<200){var p=[],f=l.clientX-this.origin.x,y=l.clientY-this.origin.y;if(0===f&&0===y||isNaN(f)||isNaN(y))return;var v=.38*y,g=2.61*y;8===this.directions.directions?f<-Math.abs(g)?p=["left"]:y<0&&f<v?p=["up","left"]:y<0&&f<Math.abs(v)?p=["up"]:y<0&&f<-g?p=["up","right"]:f>Math.abs(g)?p=["right"]:y>0&&f<-Math.abs(v)?p=["down","right"]:y>0&&f<v?p=["down"]:y>0&&f<y*g?p=["down","left"]:console.error("Not a known angle / direction"):4===this.directions.directions?f<0&&f<-Math.abs(y)?p=["left"]:y<0&&f<-y?p=["up"]:f>0&&f>Math.abs(y)?p=["right"]:y>0&&f<y?p=["down"]:console.error("Not a known angle / direction"):2===this.directions.directions?f<0?p=["left"]:f>0?p=["right"]:console.error("Not a known angle / direction"):console.error("Only 2, 4 or 8 directions allowed"),this.processDirectionChange(this.lastDirection,p),this.lastDirection=p}}else if("touchend"==e.type)for(t=0;t<e.changedTouches.length;t++){e.changedTouches[t].identifier===this.origin.id&&(this.origin.x=null,this.origin.y=null,this.origin.id=null,this.lastDirection.length>0&&this.processDirectionChange(this.lastDirection,[]),this.lastDirection=[])}},n.prototype.getDirectionAscii=function(e){return this.directionMapping[e]},n.prototype.setOrigin=function(e){this.origin={x:e.clientX,y:e.clientY,id:e.identifier}},n.prototype.unload=function(){this.dosRef.exit()},n.isTouch=function(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0},n}();export{n as DosGame};
//# sourceMappingURL=index7.js.map
